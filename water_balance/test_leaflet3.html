<!DOCTYPE html>
<html>
<head>
    <title>Leaflet Map with Date Selection</title>
    <!-- Include Leaflet.js library via CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Include jQuery via CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Include Bootstrap 5 and datepicker libraries -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.7.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.7.0/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/js/bootstrap-datepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/css/bootstrap-datepicker.min.css">
    <style>
        /* Style the map container */
        #map {
            height: 500px;
        }
    </style>
</head>
<body>
    <!-- Date selection controls -->
    <div class="container mt-3">
        <div class="row">
            <div class="col-md-4">
                <label for="startDate">Start Date:</label>
                <input type="text" id="startDate" class="form-control">
            </div>
            <div class="col-md-4">
                <label for="endDate">End Date:</label>
                <input type="text" id="endDate" class="form-control">
            </div>
            <div class="col-md-4 mt-4">
                <button id="updateMap" class="btn btn-primary">Update Map</button>
            </div>
        </div>
    </div>

    <!-- Create a map container -->
    <div id="map" class="mt-3"></div>

    <script>
        // Initialize the map and set its initial view
        var map = L.map('map', {
            zoom: 9,
            center: [13.605215264798368, 101.54519139510974],
            gestureHandling: true
        });

        // Add a tile layer to the map (you can use any compatible tile layer)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Datepicker initialization
        $('#startDate').datepicker({
            format: 'yyyy-mm-dd'
        });

        $('#endDate').datepicker({
            format: 'yyyy-mm-dd'
        });

        // Function to update the map
        function updateMap() {
            // Get selected start and end dates
            var startDate = $('#startDate').val();
            var endDate = $('#endDate').val();

            // Define the URL of the API with dynamic date parameters
            var apiUrl = 'http://113.53.253.56:5050/get_rain_data?' +
                'start_year=' + startDate.substring(0, 4) +
                '&start_month=' + startDate.substring(5, 7) +
                '&start_day=' + startDate.substring(8, 10) +
                '&end_year=' + endDate.substring(0, 4) +
                '&end_month=' + endDate.substring(5, 7) +
                '&end_day=' + endDate.substring(8, 10);

            console.log(apiUrl)

            // Clear the existing GeoJSON layer if it exists
            if (geojsonLayer) {
                map.removeLayer(geojsonLayer);
            }

            // Fetch GeoJSON data from the API and update the map
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(geojsonData => {
                    // Create a new GeoJSON layer and add it to the map
                    geojsonLayer = L.geoJSON(geojsonData, {
                        style: function (feature) {
                            // Customize the polygon style (e.g., color)
                            return {
                                fillColor: 'blue',
                                color: 'white',
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0.5
                            };
                        },
                        onEachFeature: function (feature, layer) {
                            // Customize the popup content for each feature
                            var popupContent = "<p><strong>Accumulated Rain:</strong> " + feature.properties.Accumulated_Rain + " mm</p>";
                            layer.bindPopup(popupContent);
                        }
                    }).addTo(map);
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    alert('Error: ' + error.message);
                });
        }

        // Call the updateMap function when the "Update Map" button is clicked
        $('#updateMap').click(function () {
            updateMap();
        });

        // Initial map update
        updateMap();
    </script>
</body>
</html>
